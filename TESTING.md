# å•å…ƒæµ‹è¯•å®ŒæˆæŠ¥å‘Š

## æµ‹è¯•æ¦‚è§ˆ

âœ… **æµ‹è¯•æ¡†æ¶æ­å»ºå®Œæˆ**
âœ… **æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å·²ç¼–å†™**
âœ… **æµ‹è¯•é…ç½®å·²å®Œæˆ**

### æµ‹è¯•ç»Ÿè®¡

- **æ€»æµ‹è¯•ç”¨ä¾‹æ•°**: 36ä¸ª
- **æµ‹è¯•æ¨¡å—æ•°**: 5ä¸ª
- **ä»£ç è¦†ç›–èŒƒå›´**: APIæ¥å£å±‚ã€æœåŠ¡å±‚ã€æ•°æ®æ¨¡å‹å±‚

## æµ‹è¯•æ¨¡å—è¯¦æƒ…

### 1. è®¤è¯æ¨¡å—æµ‹è¯• (`tests/test_auth.py`)

**æµ‹è¯•ç”¨ä¾‹æ•°**: 7ä¸ª

- âœ… `test_login_success` - æµ‹è¯•ç™»å½•æˆåŠŸ
- âœ… `test_login_wrong_password` - æµ‹è¯•ç™»å½•å¯†ç é”™è¯¯
- âœ… `test_login_user_not_found` - æµ‹è¯•ç™»å½•ç”¨æˆ·ä¸å­˜åœ¨
- âœ… `test_get_current_user` - æµ‹è¯•è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- âœ… `test_get_current_user_without_token` - æµ‹è¯•æœªæºå¸¦tokenè·å–ç”¨æˆ·ä¿¡æ¯
- âœ… `test_get_current_user_invalid_token` - æµ‹è¯•æ— æ•ˆtokenè·å–ç”¨æˆ·ä¿¡æ¯
- âœ… `test_logout` - æµ‹è¯•ç™»å‡º

### 2. èŒä½ç®¡ç†æµ‹è¯• (`tests/test_jobs.py`)

**æµ‹è¯•ç”¨ä¾‹æ•°**: 11ä¸ª

- âœ… `test_get_jobs_list` - æµ‹è¯•è·å–èŒä½åˆ—è¡¨
- âœ… `test_get_jobs_with_search` - æµ‹è¯•æœç´¢èŒä½
- âœ… `test_get_jobs_with_status_filter` - æµ‹è¯•æŒ‰çŠ¶æ€ç­›é€‰èŒä½
- âœ… `test_get_job_detail` - æµ‹è¯•è·å–èŒä½è¯¦æƒ…
- âœ… `test_get_job_not_found` - æµ‹è¯•è·å–ä¸å­˜åœ¨çš„èŒä½
- âœ… `test_create_job` - æµ‹è¯•åˆ›å»ºèŒä½
- âœ… `test_update_job` - æµ‹è¯•æ›´æ–°èŒä½
- âœ… `test_update_job_status` - æµ‹è¯•æ›´æ–°èŒä½çŠ¶æ€
- âœ… `test_duplicate_job` - æµ‹è¯•å¤åˆ¶èŒä½
- âœ… `test_delete_job` - æµ‹è¯•åˆ é™¤èŒä½
- âœ… `test_ai_generate_job` - æµ‹è¯•AIç”ŸæˆèŒä½æè¿°

### 3. ç®€å†ç®¡ç†æµ‹è¯• (`tests/test_resumes.py`)

**æµ‹è¯•ç”¨ä¾‹æ•°**: 10ä¸ª

- âœ… `test_get_resumes_list` - æµ‹è¯•è·å–ç®€å†åˆ—è¡¨
- âœ… `test_get_resumes_with_search` - æµ‹è¯•æœç´¢ç®€å†
- âœ… `test_get_resumes_with_status_filter` - æµ‹è¯•æŒ‰çŠ¶æ€ç­›é€‰ç®€å†
- âœ… `test_get_resumes_with_job_filter` - æµ‹è¯•æŒ‰èŒä½ç­›é€‰ç®€å†
- âœ… `test_get_resume_detail` - æµ‹è¯•è·å–ç®€å†è¯¦æƒ…
- âœ… `test_get_resume_not_found` - æµ‹è¯•è·å–ä¸å­˜åœ¨çš„ç®€å†
- âœ… `test_update_resume_status` - æµ‹è¯•æ›´æ–°ç®€å†çŠ¶æ€
- âœ… `test_ai_match_resume` - æµ‹è¯•AIåŒ¹é…åˆ†æ
- âœ… `test_send_email_to_candidate` - æµ‹è¯•å‘é€é‚®ä»¶
- âœ… `test_download_resume` - æµ‹è¯•ä¸‹è½½ç®€å†

### 4. ç»Ÿè®¡æ•°æ®æµ‹è¯• (`tests/test_stats.py`)

**æµ‹è¯•ç”¨ä¾‹æ•°**: 5ä¸ª

- âœ… `test_get_dashboard_stats` - æµ‹è¯•è·å–Dashboardç»Ÿè®¡
- âœ… `test_get_job_stats` - æµ‹è¯•è·å–èŒä½ç»Ÿè®¡
- âœ… `test_get_resume_stats` - æµ‹è¯•è·å–ç®€å†ç»Ÿè®¡
- âœ… `test_get_channel_stats` - æµ‹è¯•è·å–æ¸ é“ç»Ÿè®¡
- âœ… `test_get_funnel_stats` - æµ‹è¯•è·å–æ‹›è˜æ¼æ–—ç»Ÿè®¡

### 5. è´¦æˆ·è®¾ç½®æµ‹è¯• (`tests/test_account.py`)

**æµ‹è¯•ç”¨ä¾‹æ•°**: 3ä¸ª

- âœ… `test_update_password_success` - æµ‹è¯•æ›´æ–°å¯†ç æˆåŠŸ
- âœ… `test_update_password_wrong_current` - æµ‹è¯•æ›´æ–°å¯†ç å½“å‰å¯†ç é”™è¯¯
- âœ… `test_update_notifications` - æµ‹è¯•æ›´æ–°é€šçŸ¥è®¾ç½®

## æµ‹è¯•åŸºç¡€è®¾æ–½

### Fixtures (æµ‹è¯•å¤¹å…·)

å·²åˆ›å»ºä»¥ä¸‹å…±äº«æµ‹è¯•fixtureï¼š

1. **æ•°æ®åº“ç›¸å…³**
   - `engine` - æµ‹è¯•æ•°æ®åº“å¼•æ“ï¼ˆsessionçº§åˆ«ï¼‰
   - `db_session` - æ•°æ®åº“ä¼šè¯ï¼ˆå‡½æ•°çº§åˆ«ï¼‰

2. **HTTPå®¢æˆ·ç«¯**
   - `client` - å¼‚æ­¥HTTPæµ‹è¯•å®¢æˆ·ç«¯

3. **æµ‹è¯•æ•°æ®**
   - `test_tenant` - æµ‹è¯•ç§Ÿæˆ·
   - `test_user` - æµ‹è¯•ç”¨æˆ·  
   - `test_job` - æµ‹è¯•èŒä½
   - `test_resume` - æµ‹è¯•ç®€å†

4. **è®¤è¯ç›¸å…³**
   - `auth_token` - JWTè®¤è¯Token
   - `auth_headers` - åŒ…å«è®¤è¯Tokençš„è¯·æ±‚å¤´

### é…ç½®æ–‡ä»¶

- âœ… `tests/conftest.py` - Pytesté…ç½®å’Œfixtures
- âœ… `pytest.ini` - Pytesté…ç½®æ–‡ä»¶
- âœ… `.env.test` - æµ‹è¯•ç¯å¢ƒå˜é‡æ¨¡æ¿
- âœ… `tests/README.md` - è¯¦ç»†æµ‹è¯•æ–‡æ¡£
- âœ… `tests/TEST_GUIDE.md` - å¿«é€Ÿæµ‹è¯•æŒ‡å—

## å¦‚ä½•è¿è¡Œæµ‹è¯•

### å‰ç½®æ¡ä»¶

1. **å¯åŠ¨PostgreSQLæµ‹è¯•æ•°æ®åº“**

```bash
# æ–¹æ³•1: ä½¿ç”¨Docker Composeå¯åŠ¨ï¼ˆæ¨èï¼‰
cd docker && docker-compose up -d postgres

# æ–¹æ³•2: ä½¿ç”¨å•ç‹¬çš„Dockerå®¹å™¨
docker run -d \
  --name hr-saas-test-db \
  -e POSTGRES_DB=hr_saas_test \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgrespw \
  -p 55000:5432 \
  postgres:15-alpine
```

2. **åˆå§‹åŒ–æµ‹è¯•æ•°æ®åº“**

```bash
# åˆ›å»ºæµ‹è¯•æ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
bash scripts/init_test_db.sh
```

3. **é…ç½®ç¯å¢ƒå˜é‡**

`.env.test` æ–‡ä»¶å†…å®¹ï¼š
```bash
TEST_DATABASE_URL=postgresql+asyncpg://postgres:postgrespw@localhost:55000/hr_saas_test
SECRET_KEY=test-secret-key-for-testing-only
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_HOURS=24
```

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
uv run pytest tests/ -v

# è¿è¡Œç‰¹å®šæ¨¡å—
uv run pytest tests/test_auth.py -v

# è¿è¡Œç‰¹å®šæµ‹è¯•ç”¨ä¾‹
uv run pytest tests/test_jobs.py::TestJobs::test_update_job -v

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
uv run pytest tests/ --cov=app --cov-report=html --cov-report=term-missing

# ä¿ç•™æµ‹è¯•æ•°æ®ç”¨äºè°ƒè¯•ï¼ˆä¸è‡ªåŠ¨æ¸…ç†è¡¨ï¼‰
KEEP_TEST_DATA=1 uv run pytest tests/ -v
```

## æµ‹è¯•ç‰¹ç‚¹

### 1. å¼‚æ­¥æµ‹è¯•æ”¯æŒ
- ä½¿ç”¨ `pytest-asyncio` æ”¯æŒå¼‚æ­¥æµ‹è¯•
- æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹éƒ½æ˜¯å¼‚æ­¥çš„ï¼ŒçœŸå®æ¨¡æ‹ŸAPIè¯·æ±‚

### 2. æ•°æ®éš”ç¦»
- æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“äº‹åŠ¡
- æµ‹è¯•å®Œæˆåè‡ªåŠ¨å›æ»šï¼Œä¿è¯æ•°æ®éš”ç¦»
- **æµ‹è¯•ç»“æŸåä¼šè‡ªåŠ¨åˆ é™¤æ‰€æœ‰è¡¨**ï¼ˆå¯é€šè¿‡ `KEEP_TEST_DATA=1` ç¯å¢ƒå˜é‡ä¿ç•™ï¼‰

### 3. çœŸå®ç¯å¢ƒæ¨¡æ‹Ÿ
- ä½¿ç”¨ `httpx.AsyncClient` æ¨¡æ‹ŸçœŸå®HTTPè¯·æ±‚
- å®Œæ•´çš„è¯·æ±‚/å“åº”æµç¨‹æµ‹è¯•
- JWTè®¤è¯æµç¨‹æµ‹è¯•

### 4. PostgreSQLåŸç”Ÿæ”¯æŒ
- æ”¯æŒPostgreSQLç‰¹æœ‰æ•°æ®ç±»å‹ï¼ˆARRAYã€JSONBã€UUIDï¼‰
- ä½¿ç”¨çœŸå®PostgreSQLæ•°æ®åº“ï¼Œä¸ä½¿ç”¨SQLite
- ç¡®ä¿æµ‹è¯•ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒä¸€è‡´

## æŠ€æœ¯æ ˆ

- **æµ‹è¯•æ¡†æ¶**: Pytest 8.4.2
- **å¼‚æ­¥æ”¯æŒ**: pytest-asyncio 1.2.0
- **HTTPå®¢æˆ·ç«¯**: HTTPX
- **æ•°æ®åº“**: PostgreSQL + asyncpg
- **è¦†ç›–ç‡å·¥å…·**: pytest-cov 7.0.0

## æ–‡æ¡£

- ğŸ“– [å®Œæ•´æµ‹è¯•æ–‡æ¡£](tests/README.md) - è¯¦ç»†çš„æµ‹è¯•è¯´æ˜å’Œæœ€ä½³å®è·µ
- ğŸš€ [å¿«é€Ÿæµ‹è¯•æŒ‡å—](tests/TEST_GUIDE.md) - å¿«é€Ÿä¸Šæ‰‹æµ‹è¯•çš„æ­¥éª¤
- âš™ï¸ [æµ‹è¯•é…ç½®](tests/conftest.py) - Fixtureså’Œé…ç½®è¯¦æƒ…

## ä¸‹ä¸€æ­¥å»ºè®®

1. **é›†æˆåˆ°CI/CD**
   - å°†æµ‹è¯•é›†æˆåˆ°GitHub Actionsæˆ–å…¶ä»–CI/CDå¹³å°
   - æ¯æ¬¡PRè‡ªåŠ¨è¿è¡Œæµ‹è¯•

2. **æ‰©å±•æµ‹è¯•è¦†ç›–**
   - æ·»åŠ æ¸ é“ç®¡ç†ã€é¢è¯•ç®¡ç†ã€AIä»»åŠ¡ç­‰æ¨¡å—çš„æµ‹è¯•
   - å¢åŠ è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µçš„æµ‹è¯•

3. **æ€§èƒ½æµ‹è¯•**
   - æ·»åŠ APIæ€§èƒ½æµ‹è¯•
   - æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æµ‹è¯•

4. **é›†æˆæµ‹è¯•**
   - ç«¯åˆ°ç«¯æµ‹è¯•åœºæ™¯
   - å¤šæ¨¡å—äº¤äº’æµ‹è¯•

## æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æé†’**ï¼š

1. æµ‹è¯•å¿…é¡»ä½¿ç”¨PostgreSQLæ•°æ®åº“ï¼Œä¸æ”¯æŒSQLite
2. **ç¡®ä¿æµ‹è¯•æ•°æ®åº“ä¸ç”Ÿäº§æ•°æ®åº“éš”ç¦»**ï¼ˆä½¿ç”¨ç‹¬ç«‹çš„ `hr_saas_test` æ•°æ®åº“ï¼‰
3. æµ‹è¯•å‰éœ€è¦å¯åŠ¨PostgreSQLæœåŠ¡
4. **æµ‹è¯•ä¼šè‡ªåŠ¨åˆ›å»ºå’Œæ¸…ç†æ•°æ®åº“è¡¨ç»“æ„**
   - æµ‹è¯•å¼€å§‹å‰ï¼šåˆ é™¤æ‰€æœ‰è¡¨ â†’ é‡æ–°åˆ›å»ºè¡¨ç»“æ„
   - æµ‹è¯•ç»“æŸåï¼šé»˜è®¤åˆ é™¤æ‰€æœ‰è¡¨ï¼ˆå¯é€šè¿‡ `KEEP_TEST_DATA=1` ä¿ç•™ï¼‰
5. å¦‚æœéœ€è¦ä¿ç•™æµ‹è¯•æ•°æ®ç”¨äºè°ƒè¯•ï¼š`KEEP_TEST_DATA=1 pytest tests/`
6. å¼€å‘æ•°æ®åº“ä¸ä¼šå—å½±å“ï¼Œå› ä¸ºæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥

### æµ‹è¯•æ•°æ®åº“æ¸…ç†æœºåˆ¶

```python
# æµ‹è¯•æµç¨‹è¯´æ˜
1. æµ‹è¯•å¼€å§‹ â†’ åˆ é™¤æ‰€æœ‰è¡¨ â†’ åˆ›å»ºè¡¨ç»“æ„
2. è¿è¡Œæµ‹è¯• â†’ æ¯ä¸ªæµ‹è¯•ç”¨ç‹¬ç«‹äº‹åŠ¡ â†’ æµ‹è¯•åå›æ»š
3. æµ‹è¯•ç»“æŸ â†’ åˆ é™¤æ‰€æœ‰è¡¨ï¼ˆé™¤éè®¾ç½® KEEP_TEST_DATA=1ï¼‰
```

### æŸ¥çœ‹æµ‹è¯•æ•°æ®åº“

å¦‚æœéœ€è¦åœ¨æµ‹è¯•åæŸ¥çœ‹æ•°æ®åº“å†…å®¹ï¼š

```bash
# æ–¹æ³•1: ä¿ç•™æµ‹è¯•æ•°æ®è¿è¡Œ
KEEP_TEST_DATA=1 pytest tests/test_jobs.py -v

# æ–¹æ³•2: è¿æ¥åˆ°æµ‹è¯•æ•°æ®åº“
docker exec -it postgres_container psql -U postgres -d hr_saas_test

# æŸ¥çœ‹è¡¨
\dt

# æŸ¥çœ‹æ•°æ®
SELECT * FROM jobs;
```

## æ€»ç»“

âœ¨ å·²å®Œæˆ36ä¸ªæµ‹è¯•ç”¨ä¾‹çš„ç¼–å†™ï¼Œè¦†ç›–5ä¸ªæ ¸å¿ƒæ¨¡å—çš„APIæ¥å£æµ‹è¯•ã€‚æµ‹è¯•æ¡†æ¶å®Œæ•´ï¼Œæ”¯æŒå¼‚æ­¥æµ‹è¯•å’ŒPostgreSQLæ•°æ®åº“ï¼Œå¯ä»¥ç«‹å³å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•ã€‚

æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹éƒ½éµå¾ªAAAæ¨¡å¼ï¼ˆArrange-Act-Assertï¼‰ï¼Œå…·æœ‰è‰¯å¥½çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

